<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Calculadora de Variabilidade de Plantões</title>
  <meta name="description" content="Calcula série mensal com feriados nacionais e gráfico de tendência (set/2025 → dez/2026)." />
  <meta name="theme-color" content="#196396">

  <!-- Favicon e OpenGraph -->
  <link rel="icon" href="https://axcare.com.br/favicon.ico">
  <meta property="og:locale" content="pt_BR">
  <meta property="og:type" content="website">
  <meta property="og:title" content="Calculadora de Variabilidade de Plantões">
  <meta property="og:description" content="Três especialidades, orçamento base montado a partir de valores de consulta e consultas por plantão, com série mensal e feriados nacionais.">
  <meta property="og:image" content="https://i.imgur.com/wY4gVDs.png">
  <meta property="og:url" content="#">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Calculadora de Variabilidade de Plantões">
  <meta name="twitter:description" content="Três especialidades, orçamento base por consultas e série mensal com feriados nacionais.">
  <meta name="twitter:image" content="https://i.imgur.com/wY4gVDs.png">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      /* Paleta AxiaCare */
      --ax-primary:#196396;   /* azul */
      --ax-mint:#a6d8c0;      /* verde-mint */
      --ax-ink:#2d3445;       /* cinza-azulado escuro */
      --ax-cream:#f8f5f0;     /* bege suave */
      --ax-border:#e5e7eb;    /* borda */
      --ax-ok:#065f46;        /* verde ok */
      --ax-warn:#b91c1c;      /* vermelho variação + */
      --ax-shadow:0 10px 30px rgba(0,0,0,.08);

      /* Cores de séries */
      --serie1:#196396;
      --serie1-bg:#19639622;
      --serie2:#10b981;
      --serie2-bg:#10b98122;
      --serie3:#ff8f00;
      --serie3-bg:#ff8f0022;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter, Roboto, Arial, Helvetica, sans-serif;
      color:#111;
      background:linear-gradient(180deg,#fbfcfe 0%, #f6f9fb 60%, #f4f7fa 100%);
    }

    /* ===== Hero profissional (fixo) ===== */
    .hero{
      position:sticky; top:0; z-index:60;
      background:
        radial-gradient(1200px 300px at 50% -120px, #e6f0f7 0%, rgba(230,240,247,0) 60%),
        linear-gradient(180deg, rgba(255,255,255,.85) 0%, rgba(255,255,255,.76) 100%);
      backdrop-filter: blur(8px) saturate(135%);
      border-bottom:1px solid var(--ax-border);
      transition: box-shadow .25s ease;
    }
    .hero.scrolled{ box-shadow: var(--ax-shadow); }
    .hero-inner{
      max-width:1200px; margin:0 auto; padding:12px 16px;
      display:grid; grid-template-columns:1fr auto 1fr; align-items:center; gap:14px;
    }
    .hero-col{ display:flex; align-items:center }
    .hero-left{ justify-content:flex-start }
    .hero-right{ justify-content:flex-end }
    .brand-link{ display:inline-flex; align-items:center; text-decoration:none; opacity:.95; transition:opacity .2s, transform .2s }
    .brand-link:hover{ opacity:1; transform:translateY(-1px) }
    .brand{ height:44px }
    .hero-title{ text-align:center; line-height:1.1 }
    .hero-title h1{ margin:0; font-size:26px; font-weight:900; color:var(--ax-primary); letter-spacing:.2px }
    .hero-title p{ margin:6px 0 0; font-size:13.5px; color:#475569 }

    /* ===== Layout base ===== */
    .wrap{ max-width:1200px; margin:18px auto; padding:0 16px }
    .card{
      background:#fff; border:1px solid var(--ax-border);
      border-radius:18px; box-shadow:var(--ax-shadow);
    }

    /* ===== Controles ===== */
    .controls{
      display:grid; grid-template-columns:1fr; gap:14px; padding:18px;
    }
    .grid-esp{
      display:grid; grid-template-columns: repeat(12, 1fr); gap:12px;
    }
    .esp-card{
      grid-column: span 12;
      background:linear-gradient(180deg,#f8fbfd 0%,#f3f7fa 100%);
      border:1px solid var(--ax-border); border-radius:14px; padding:12px;
    }
    .esp-title{ display:flex; align-items:center; justify-content:space-between; margin-bottom:10px }
    .esp-title h4{ margin:0; font-size:14px; font-weight:900; color:#0f172a }
    .toggle{ display:flex; align-items:center; gap:8px; font-size:12.5px; color:#334155 }
    .toggle input{ width:18px; height:18px }

    .fields{ display:grid; grid-template-columns: repeat(12, 1fr); gap:10px }
    .field{ grid-column: span 12 }
    .field.half{ grid-column: span 6 }
    .field.third{ grid-column: span 4 }
    .field label{ font-size:12.5px; color:#0f172a; font-weight:800; display:block }
    .field .hint{ display:block; margin-top:2px; font-size:12px; color:#64748b }
    .input-group{ margin-top:8px; display:flex; align-items:stretch; width:100% }
    .input-prefix{
      background:#f1f5f9; border:1px solid var(--ax-border); border-right:0; padding:0 10px;
      display:inline-flex; align-items:center; border-top-left-radius:10px; border-bottom-left-radius:10px; color:#334155; font-weight:700; font-size:14px
    }
    input[type="text"], input[type="number"]{
      flex:1; padding:10px 12px; border:1px solid var(--ax-border);
      border-left:0; border-top-right-radius:10px; border-bottom-right-radius:10px;
      font-size:14px; transition:border-color .2s, box-shadow .2s
    }
    input[type="number"]:focus, input[type="text"]:focus{
      outline:none; border-color:#b9d6ea; box-shadow:0 0 0 4px rgba(25,99,150,.12)
    }

    .actions{ display:flex; gap:10px; align-items:end; justify-content:flex-end; margin-top:4px }
    .btn{
      border:1px solid transparent; border-radius:12px; padding:11px 16px;
      font-weight:900; font-size:14px; cursor:pointer;
      transition:transform .12s ease, box-shadow .2s ease, opacity .15s
    }
    .btn:active{ transform:translateY(0) scale(.98) }
    .btn-primary{ background:var(--ax-primary); color:#fff }
    .btn-primary:hover{ box-shadow:0 12px 26px rgba(25,99,150,.25) }
    .btn-ghost{ background:#fff; color:#0f172a; border-color:var(--ax-border) }
    .btn-ghost:hover{ box-shadow:0 12px 24px rgba(0,0,0,.08) }

    /* ===== Tabela ===== */
    .table-wrap{ padding:18px }
    .table-scroller{ overflow:auto; max-height:60vh }
    table{ width:100%; border-collapse:separate; border-spacing:0 }
    thead th{
      position:sticky; top:0; z-index:1;
      text-align:left; font-size:12.5px; color:#334155; letter-spacing:.2px;
      border-bottom:1px solid var(--ax-border); padding:10px; background:#fbfdff; white-space:nowrap
    }
    tbody td{
      padding:10px; border-bottom:1px solid #f1f5f9; font-size:14px; vertical-align:top
    }
    tbody tr:nth-child(even){ background:#fcfdff }
    tbody tr:hover{ background:#f7fbff }
    .num{ text-align:right; white-space:nowrap }
    .delta-pos{ color:var(--ax-warn); font-weight:800 } /* +custo */
    .delta-neg{ color:var(--ax-ok); font-weight:800 }    /* -custo */
    .muted-row{ color:#64748b }

    /* ===== Gráfico ===== */
    .chart-wrap{ padding:18px }
    .chart-legend{ font-size:12px; color:#475569; margin-top:8px }

    /* ===== Rodapé institucional ===== */
    .footer {
      margin-top: 40px;
      padding: 25px 15px;
      background-color: var(--ax-cream);
      text-align: center;
      font-family: Verdana, sans-serif;
      border-top: 2px solid #006b68;
    }
    .footer-logo { width:140px; margin:0 auto 10px auto; display:block }
    .footer-title { font-size:15px; font-weight:bold; color:#333; margin:10px 0 18px }
    .footer-links, .footer-social {
      display:flex; flex-wrap:wrap; justify-content:center; gap:8px; font-size:14px; margin-bottom:10px;
    }
    .footer-links a, .footer-social a { color:#004E4C; text-decoration:none; position:relative; padding:0 4px }
    .footer-links a:hover, .footer-social a:hover { color:#002c2a; text-decoration:underline }
    .footer .separator { color:#bbb; margin:0 4px }
    .footer-copyright { margin-top:18px; font-size:11px; color:#999 }

    /* ===== Responsivo ===== */
    @media (max-width:980px){
      .hero-inner{ grid-template-columns:1fr; gap:8px; text-align:center }
      .hero-left, .hero-right{ justify-content:center }
      .brand{ height:36px }
      .hero-title h1{ font-size:22px }
      .fields .field.half{ grid-column: span 12 }
      .fields .field.third{ grid-column: span 12 }
      .table-scroller{ max-height:unset }
    }

    /* ===== Impressão/PDF: A4 paisagem em uma página ===== */
    @media print{
      @page{ size: A4 landscape; margin: 10mm }
      body{ background:#fff }
      .hero{ position:static; border-bottom:0 }
      .hero-title h1{ font-size:20px }
      .hero-title p{ font-size:11px }
      .card{ box-shadow:none }
      .controls{ gap:10px; padding:10px }
      .btn{ display:none !important }
      .chart-wrap{ padding:10px }
      .chart-wrap canvas{ height:240px !important }
      .table-wrap{ padding:10px }
      table thead th{ padding:6px; font-size:11px }
      table tbody td{ padding:6px; font-size:11px; page-break-inside:avoid }
      .footer{ padding:16px 10px }
      .footer-title{ font-size:13px }
      .footer-links, .footer-social{ font-size:12px }
    }
  </style>
</head>
<body>

  <!-- HERO -->
  <div class="hero" id="hero">
    <div class="hero-inner">
      <div class="hero-col hero-left">
        <a class="brand-link" href="https://axcare.com.br" target="_blank" rel="noopener">
          <img class="brand" src="https://i.imgur.com/yAUQciP.png" alt="AxiaCare">
        </a>
      </div>
      <div class="hero-col">
        <div class="hero-title">
          <h1>Calculadora de Variabilidade de Plantões</h1>
          <p>Impacto de fins de semana e feriados nacionais (Brasil) — plantões de 12h. Período: <strong>set/2025</strong> a <strong>dez/2026</strong>.</p>
        </div>
      </div>
      <div class="hero-col hero-right">
        <a class="brand-link" href="https://icds.org.br/hospital-unimed-governador-valadares/" target="_blank" rel="noopener">
          <img class="brand" src="https://i.imgur.com/XouXBck.png" alt="Unihealth – Hospital Governador Valadares">
        </a>
      </div>
    </div>
  </div>

  <div class="wrap">
    <!-- Painel -->
    <section class="card controls" aria-labelledby="painel">
      <div class="grid-esp">
        <!-- Especialidade 1 -->
        <div class="esp-card" id="esp1">
          <div class="esp-title">
            <h4><span style="color:var(--serie1)">Especialidade 1</span></h4>
            <div class="toggle">
              <input type="checkbox" id="chk1" checked>
              <label for="chk1">Incluir no cálculo</label>
            </div>
          </div>
          <div class="fields">
            <div class="field third">
              <label>Nome</label>
              <input type="text" id="nome1" placeholder="Ex.: Clínica Médica">
            </div>
            <div class="field third">
              <label>Valor consulta especial (Rₑ)</label>
              <div class="input-group">
                <span class="input-prefix">R$</span>
                <input type="number" id="re1" step="0.01" placeholder="0,00" value="63.05">
              </div>
              <span class="hint">Aplicado em todas as noites e nos plantões diurnos de fds/feriados.</span>
            </div>
            <div class="field third">
              <label>Valor consulta tradicional (Rₜ)</label>
              <div class="input-group">
                <span class="input-prefix">R$</span>
                <input type="number" id="rt1" step="0.01" placeholder="0,00" value="48.50">
              </div>
              <span class="hint">Aplicado nos plantões diurnos em dias úteis sem feriado.</span>
            </div>
            <div class="field third">
              <label>Consultas por plantão de 12h (N)</label>
              <input type="number" id="n1" step="1" min="0" placeholder="0" value="20">
            </div>
            <div class="field third">
              <label>Orçamento base X (auto)</label>
              <input type="text" id="x1" readonly>
              <span class="hint">X = N × [ 22·Rₜ + 38·Rₑ ]</span>
            </div>
          </div>
        </div>

        <!-- Especialidade 2 -->
        <div class="esp-card" id="esp2">
          <div class="esp-title">
            <h4><span style="color:var(--serie2)">Especialidade 2</span></h4>
            <div class="toggle">
              <input type="checkbox" id="chk2" checked>
              <label for="chk2">Incluir no cálculo</label>
            </div>
          </div>
          <div class="fields">
            <div class="field third">
              <label>Nome</label>
              <input type="text" id="nome2" placeholder="Ex.: Pediatria">
            </div>
            <div class="field third">
              <label>Valor consulta especial (Rₑ)</label>
              <div class="input-group">
                <span class="input-prefix">R$</span>
                <input type="number" id="re2" step="0.01" placeholder="0,00">
              </div>
            </div>
            <div class="field third">
              <label>Valor consulta tradicional (Rₜ)</label>
              <div class="input-group">
                <span class="input-prefix">R$</span>
                <input type="number" id="rt2" step="0.01" placeholder="0,00">
              </div>
            </div>
            <div class="field third">
              <label>Consultas por plantão de 12h (N)</label>
              <input type="number" id="n2" step="1" min="0" placeholder="0">
            </div>
            <div class="field third">
              <label>Orçamento base X (auto)</label>
              <input type="text" id="x2" readonly>
              <span class="hint">X = N × [ 22·Rₜ + 38·Rₑ ]</span>
            </div>
          </div>
        </div>

        <!-- Especialidade 3 -->
        <div class="esp-card" id="esp3">
          <div class="esp-title">
            <h4><span style="color:var(--serie3)">Especialidade 3</span></h4>
            <div class="toggle">
              <input type="checkbox" id="chk3" checked>
              <label for="chk3">Incluir no cálculo</label>
            </div>
          </div>
          <div class="fields">
            <div class="field third">
              <label>Nome</label>
              <input type="text" id="nome3" placeholder="Ex.: Ortopedia">
            </div>
            <div class="field third">
              <label>Valor consulta especial (Rₑ)</label>
              <div class="input-group">
                <span class="input-prefix">R$</span>
                <input type="number" id="re3" step="0.01" placeholder="0,00">
              </div>
            </div>
            <div class="field third">
              <label>Valor consulta tradicional (Rₜ)</label>
              <div class="input-group">
                <span class="input-prefix">R$</span>
                <input type="number" id="rt3" step="0.01" placeholder="0,00">
              </div>
            </div>
            <div class="field third">
              <label>Consultas por plantão de 12h (N)</label>
              <input type="number" id="n3" step="1" min="0" placeholder="0">
            </div>
            <div class="field third">
              <label>Orçamento base X (auto)</label>
              <input type="text" id="x3" readonly>
              <span class="hint">X = N × [ 22·Rₜ + 38·Rₑ ]</span>
            </div>
          </div>
        </div>
      </div>

      <div class="actions">
        <button id="btnExportCSV" class="btn btn-primary">Exportar CSV</button>
        <button id="btnPrint" class="btn btn-ghost">Salvar em PDF</button>
      </div>
    </section>

    <!-- Série mensal -->
    <section class="card table-wrap" style="margin-top:16px;">
      <h3 style="margin:0 0 8px 0;color:#0f172a;font-size:16px;font-weight:800">
        Série mensal — setembro/2025 a dezembro/2026
      </h3>
      <div class="table-scroller">
        <table id="tbl">
          <thead>
            <tr>
              <th>Mês</th>
              <th class="num">Dias</th>
              <th class="num">Úteis (W)</th>
              <th class="num">Fins-semana (S)</th>
              <th class="num">Feriados úteis (H)</th>
              <th class="num">Valor 1</th>
              <th class="num">Var. 1</th>
              <th class="num">Valor 2</th>
              <th class="num">Var. 2</th>
              <th class="num">Valor 3</th>
              <th class="num">Var. 3</th>
              <th>Feriados (datas)</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <p class="muted-row">Feriados que caem no fim de semana não são contados em H (já compõem S).</p>
    </section>

    <!-- Gráfico -->
    <section class="card chart-wrap" style="margin-top:16px;">
      <h3 style="margin:0 0 8px 0;color:#0f172a;font-size:16px;font-weight:800">Tendência por especialidade</h3>
      <div style="width:100%;height:420px">
        <canvas id="chart"></canvas>
      </div>
      <div class="chart-legend">Linhas: valores estimados por mês. Ative/desative especialidades nos controles acima.</div>
    </section>

    <!-- Rodapé (fornecido) -->
    <div class="footer">
      <img class="footer-logo" src="https://i.imgur.com/yAUQciP.png" alt="AxiaCare Logo">
      <div class="footer-title">AxView™ | WebApp - Gestão e Consultoria em Saúde</div>
      <div class="footer-links">
        <a href="https://linktr.ee/gui.thome">Conheça nossas soluções.</a>
        <span class="separator">|</span>
        <a href="https://www.axcare.com.br">axcare.com.br</a>
        <span class="separator">|</span>
        <a href="https://www.medvalor.med.br">medvalor.med.br</a>
      </div>
      <div class="footer-social">
        <a href="https://guithome.com.br">guithome.com.br</a>
        <span class="separator">|</span>
        <a href="https://linkedin.com/in/guithome">LinkedIn</a>
        <span class="separator">|</span>
        <a href="https://www.instagram.com/gui.thome/">Instagram</a>
      </div>
      <div class="footer-copyright">
        Copyright © 2025 AxiaCare | Todos os direitos reservados | Uma empresa GTCorp.
      </div>
    </div>
  </div>

  <!-- Lógica -->
  <script>
    // Sombra no hero ao rolar
    const hero = document.getElementById('hero');
    const onScroll = () => hero.classList.toggle('scrolled', window.scrollY > 6);
    window.addEventListener('scroll', onScroll); onScroll();

    // Utilidades
    const BRL = new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'});
    const pad2 = n => n<10?`0${n}`:String(n);
    const ymd = d => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    const fmtBRL = v => BRL.format(Math.round((v + Number.EPSILON)*100)/100);

    // Páscoa (gregoriano) e Sexta-feira Santa
    function easterSunday(y){
      const a=y%19,b=Math.floor(y/100),c=y%100,d=Math.floor(b/4),e=b%4,f=Math.floor((b+8)/25),
            g=Math.floor((b-f+1)/3),h=(19*a+b-d-g+15)%30,i=Math.floor(c/4),k=c%4,l=(32+2*e+2*i-h-k)%7,
            m=Math.floor((a+11*h+22*l)/451),month=Math.floor((h+l-7*m+114)/31),day=((h+l-7*m+114)%31)+1;
      return new Date(y, month-1, day);
    }
    const addDays = (d,n)=>{ const x=new Date(d); x.setDate(x.getDate()+n); return x; };

    // Feriados nacionais fixos + Sexta-feira Santa
    const FIXO = ['01-01','04-21','05-01','09-07','10-12','11-02','11-15','11-20','12-25']; // inclui 20/11 nacional
    function feriadosAno(y){
      const s = new Set(FIXO.map(md => `${y}-${md}`));
      const gf = addDays(easterSunday(y), -2); // Good Friday
      s.add(ymd(gf));
      return s;
    }

    // Contagem por mês
    function diasMes(y,m0){ const out=[], d=new Date(y,m0,1); while(d.getMonth()===m0){ out.push(new Date(d)); d.setDate(d.getDate()+1);} return out; }
    function contadoresMes(y,m0,ferSet){
      const dias = diasMes(y,m0);
      let S=0,W=0,H=0; const listH=[];
      for(const d of dias){
        const dow=d.getDay(), weekend=(dow===0||dow===6);
        if(weekend) S++; else W++;
        const id = ymd(d);
        if(!weekend && ferSet.has(id)){ H++; listH.push(d); }
      }
      return { D:dias.length, S, W, H, listH };
    }

    // Série base (meses + feriados)
    function mesesPeriodo(){
      const arr=[]; const set25=feriadosAno(2025), set26=feriadosAno(2026);
      for(let y=2025;y<=2026;y++){
        const ini=(y===2025)?8:0, fim=11, ferSet=(y===2025)?set25:set26;
        for(let m=ini;m<=fim;m++){
          const {D,S,W,H,listH}=contadoresMes(y,m,ferSet);
          arr.push({ano:y,mes:m+1,label:`${pad2(m+1)}/${String(y).slice(-2)}`,D,S,W,H,ferList:listH});
        }
      }
      return arr;
    }
    const MESES = mesesPeriodo();

    // Elementos de entrada
    const cfg = [
      { chk: 'chk1', nome:'nome1', re:'re1', rt:'rt1', n:'n1', x:'x1', color:'var(--serie1)', bg:'var(--serie1-bg)' },
      { chk: 'chk2', nome:'nome2', re:'re2', rt:'rt2', n:'n2', x:'x2', color:'var(--serie2)', bg:'var(--serie2-bg)' },
      { chk: 'chk3', nome:'nome3', re:'re3', rt:'rt3', n:'n3', x:'x3', color:'var(--serie3)', bg:'var(--serie3-bg)' },
    ];

    function lerEspecialidade(i){
      const c = cfg[i];
      const ativo = document.getElementById(c.chk).checked;
      const nome = (document.getElementById(c.nome).value || `Especialidade ${i+1}`).trim();
      const re = parseFloat(document.getElementById(c.re).value) || 0; // especial
      const rt = parseFloat(document.getElementById(c.rt).value) || 0; // tradicional
      const n  = parseFloat(document.getElementById(c.n).value)  || 0; // consultas por 12h
      // Base X = N × [22·Rₜ + 38·Rₑ]
      const X = n * (22*rt + 38*re);
      document.getElementById(c.x).value = fmtBRL(X);
      return { ativo, nome, re, rt, n, X, color: getComputedStyle(document.documentElement).getPropertyValue(c.color).trim(), bg: getComputedStyle(document.documentElement).getPropertyValue(c.bg).trim() };
    }

    function construirSeries(){
      const esp = [lerEspecialidade(0), lerEspecialidade(1), lerEspecialidade(2)];
      const linhas = MESES.map(m => {
        // contagem de turnos
        const conv = m.W - m.H;         // diurnos úteis sem feriado
        const espDiaNoite = m.D + m.S + m.H; // noites + diurnos fds + diurnos de feriados-úteis
        // para cada especialidade, custo mês e var %
        const calc = (e) => {
          if(!e.ativo || e.n<=0) return { valor:0, varPct:0 };
          const valor = e.n * ( conv * e.rt + espDiaNoite * e.re );
          const varPct = e.X>0 ? (valor / e.X - 1) * 100 : 0;
          return { valor, varPct };
        };
        const e1 = calc(esp[0]), e2 = calc(esp[1]), e3 = calc(esp[2]);
        return {
          ...m,
          e1v:e1.valor, e1p:e1.varPct,
          e2v:e2.valor, e2p:e2.varPct,
          e3v:e3.valor, e3p:e3.varPct,
          ferDesc: m.ferList.map(d=>`${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()}`).join(', ') || '—'
        };
      });
      return { linhas, esp };
    }

    const tbody = document.getElementById('tbody');
    let chart;

    function render(){
      const { linhas, esp } = construirSeries();

      // Tabela
      tbody.innerHTML = '';
      for(const r of linhas){
        const tr = document.createElement('tr');
        const c1 = r.e1p===0?'':(r.e1p>0?'delta-pos':'delta-neg');
        const c2 = r.e2p===0?'':(r.e2p>0?'delta-pos':'delta-neg');
        const c3 = r.e3p===0?'':(r.e3p>0?'delta-pos':'delta-neg');
        tr.innerHTML = `
          <td>${r.label}</td>
          <td class="num">${r.D}</td>
          <td class="num">${r.W}</td>
          <td class="num">${r.S}</td>
          <td class="num">${r.H}</td>
          <td class="num">${r.e1v?fmtBRL(r.e1v):'—'}</td>
          <td class="num ${c1}">${r.e1v?((r.e1p>0?'+':r.e1p<0?'−':'')+Math.abs(r.e1p).toFixed(2)+'%'):'—'}</td>
          <td class="num">${r.e2v?fmtBRL(r.e2v):'—'}</td>
          <td class="num ${c2}">${r.e2v?((r.e2p>0?'+':r.e2p<0?'−':'')+Math.abs(r.e2p).toFixed(2)+'%'):'—'}</td>
          <td class="num">${r.e3v?fmtBRL(r.e3v):'—'}</td>
          <td class="num ${c3}">${r.e3v?((r.e3p>0?'+':r.e3p<0?'−':'')+Math.abs(r.e3p).toFixed(2)+'%'):'—'}</td>
          <td>${r.ferDesc}</td>
        `;
        tbody.appendChild(tr);
      }

      // Gráfico
      const ctx = document.getElementById('chart').getContext('2d');
      if(chart) chart.destroy();
      const labels = linhas.map(r=>r.label);

      const ds = [];
      if(esp[0].ativo && esp[0].n>0){
        ds.push({
          label: esp[0].nome || 'Especialidade 1',
          data: linhas.map(r=>r.e1v || null),
          yAxisID:'y',
          tension:.25,
          borderColor: esp[0].color || '#196396',
          backgroundColor: esp[0].bg || '#19639622',
          spanGaps:true
        });
      }
      if(esp[1].ativo && esp[1].n>0){
        ds.push({
          label: esp[1].nome || 'Especialidade 2',
          data: linhas.map(r=>r.e2v || null),
          yAxisID:'y',
          tension:.25,
          borderColor: esp[1].color || '#10b981',
          backgroundColor: esp[1].bg || '#10b98122',
          spanGaps:true
        });
      }
      if(esp[2].ativo && esp[2].n>0){
        ds.push({
          label: esp[2].nome || 'Especialidade 3',
          data: linhas.map(r=>r.e3v || null),
          yAxisID:'y',
          tension:.25,
          borderColor: esp[2].color || '#ff8f00',
          backgroundColor: esp[2].bg || '#ff8f0022',
          spanGaps:true
        });
      }

      chart = new Chart(ctx,{
        type:'line',
        data:{ labels, datasets: ds },
        options:{
          responsive:true, maintainAspectRatio:false,
          interaction:{mode:'index',intersect:false},
          plugins:{
            legend:{position:'top'},
            tooltip:{callbacks:{
              label:(ctx)=>` ${ctx.dataset.label}: ${fmtBRL(ctx.parsed.y)}`
            }}
          },
          scales:{
            y:{type:'linear',position:'left',title:{display:true,text:'Valor (BRL)'},
               ticks:{callback:(v)=>BRL.format(v)}}
          }
        }
      });

      // Export CSV
      document.getElementById('btnExportCSV').onclick = ()=>{
        const header=['mes','ano','dias','uteis','fds','feriados_uteis','valor_esp1','var_pct_esp1','valor_esp2','var_pct_esp2','valor_esp3','var_pct_esp3'];
        const lines = linhas.map(r=>[
          r.mes,r.ano,r.D,r.W,r.S,r.H,
          r.e1v?.toFixed(2)||'', r.e1p?.toFixed(2)||'',
          r.e2v?.toFixed(2)||'', r.e2p?.toFixed(2)||'',
          r.e3v?.toFixed(2)||'', r.e3p?.toFixed(2)||''
        ].join(','));
        const csv=[header.join(','),...lines].join('\n');
        const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
        const url=URL.createObjectURL(blob); const a=document.createElement('a');
        a.href=url; a.download='variabilidade_plantoes_multiesp_2025-09_a_2026-12.csv';
        a.click(); URL.revokeObjectURL(url);
      };

      document.getElementById('btnPrint').onclick = ()=>window.print();
    }

    // Bind inputs
    for(const c of cfg){
      ['change','input'].forEach(ev=>{
        document.getElementById(c.chk).addEventListener(ev, ()=>render());
        document.getElementById(c.nome).addEventListener(ev, ()=>render());
        document.getElementById(c.re).addEventListener(ev, ()=>render());
        document.getElementById(c.rt).addEventListener(ev, ()=>render());
        document.getElementById(c.n).addEventListener(ev, ()=>render());
      });
    }

    // Inicial
    render();
  </script>
</body>
</html>
